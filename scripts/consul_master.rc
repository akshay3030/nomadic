#!/bin/bash

# startup script for consul
# chkconfig: 2345 20 80
# description: Starts and stops consul

. /etc/init.d/functions
PROG=consul
PROG_BIN=/usr/local/bin/$PROG
PROG_LOCKFILE=/var/lock/subsys/$PROG
PROG_LOGFILE=/var/log/$PROG.log
PROG_PIDFILE=/var/run/$PROG.pid
PROG_CONFIGFILE=/root/consul_config.json

IP_ADDRESS=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)

start() {
  started=$(status -p "$PROG_PIDFILE" "$PROG_BIN")
  [[ $started =~ running ]] && echo $started && return 1
  echo "Starting $PROG "
  nohup $PROG_BIN agent -config-file $PROG_CONFIGFILE -client $IP_ADDRESS -advertise $IP_ADDRESS -data-dir consul-data -server -ui -bootstrap >>$PROG_LOGFILE 2>&1 &
}

stop() {
  echo "Stopping $PROG "
  killproc -p "$PROG_PIDFILE" "$PROG_BIN"
  RETVAL=$?
  echo
  [ $RETVAL -eq 0 ] && rm -f "$PROG_LOCKFILE"
  return $RETVAL
}

case $1 in
  start)
    start
  ;;

  stop)
    stop
  ;;

  restart)
    stop
    start
  ;;

  *)
    echo "Usage $0 {start|stop}"
    RETVAL=1
  ;;

esac
exit $RETVAL
